# Gmail ç”¨æˆ·åæ£€æŸ¥å™¨ - åˆ†å¸ƒå¼ GitHub Actions Workflow
# 
# ä½¿ç”¨æ–¹æ³•:
# 1. å…ˆåœ¨æœ¬åœ°è¿è¡Œ: node gmail-checker-playwright/split-usernames.js <ç”¨æˆ·åæ–‡ä»¶> <æ‰¹æ¬¡æ•°>
# 2. å°† batches/ ç›®å½•æäº¤åˆ°ä»“åº“
# 3. åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤ workflow
# 4. å®Œæˆåä¸‹è½½ Artifacts å¹¶è¿è¡Œ: node gmail-checker-playwright/merge-results.js

name: Gmail Username Checker

on:
  workflow_dispatch:
    inputs:
      batch_count:
        description: 'å¹¶è¡Œæ‰¹æ¬¡æ•°é‡ (éœ€è¦å…ˆåˆ†å‰²ç”¨æˆ·åæ–‡ä»¶)'
        required: true
        default: '5'
        type: choice
        options:
          - '3'
          - '5'
          - '10'
          - '15'
          - '20'
      request_delay:
        description: 'è¯·æ±‚é—´éš” (ms) - è¶Šå¤§è¶Šç¨³å®š'
        required: true
        default: '400'
        type: choice
        options:
          - '300'
          - '350'
          - '400'
          - '500'

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5 å°æ—¶è¶…æ—¶
    
    strategy:
      matrix:
        batch: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
      fail-fast: false  # ä¸€ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–
      max-parallel: 20  # æœ€å¤§å¹¶è¡Œæ•°
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: gmail-checker-playwright/package-lock.json
      
      - name: Install dependencies
        working-directory: gmail-checker-playwright
        run: npm ci
      
      - name: Install Playwright browsers
        working-directory: gmail-checker-playwright
        run: npx playwright install chromium --with-deps
      
      - name: Install xvfb
        run: sudo apt-get install -y xvfb
      
      - name: Check batch file exists
        id: check_batch
        run: |
          if [ -f "gmail-checker-playwright/batches/batch-${{ matrix.batch }}.txt" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… batch-${{ matrix.batch }}.txt å­˜åœ¨"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ batch-${{ matrix.batch }}.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
      
      - name: Run checker
        if: steps.check_batch.outputs.exists == 'true'
        working-directory: gmail-checker-playwright
        run: |
          mkdir -p results-${{ matrix.batch }}
          xvfb-run --auto-servernum node checker-distributed.js batches/batch-${{ matrix.batch }}.txt results-${{ matrix.batch }}
        env:
          REQUEST_DELAY: ${{ github.event.inputs.request_delay }}
        timeout-minutes: 60
        continue-on-error: true  # å³ä½¿å¤±è´¥ä¹Ÿä¸Šä¼ ç»“æœ
      
      - name: Upload results
        if: steps.check_batch.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: results-batch-${{ matrix.batch }}
          path: |
            gmail-checker-playwright/results-${{ matrix.batch }}/
          retention-days: 7
          if-no-files-found: warn

  # åˆå¹¶æ‰€æœ‰ç»“æœ
  merge:
    needs: check
    runs-on: ubuntu-latest
    if: always()  # å³ä½¿éƒ¨åˆ† job å¤±è´¥ä¹Ÿè¿è¡Œ
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: results-batch-*
      
      - name: Merge results
        working-directory: gmail-checker-playwright
        run: |
          mkdir -p ../merged-results
          node merge-results.js ../all-results ../merged-results
      
      - name: Upload merged results
        uses: actions/upload-artifact@v4
        with:
          name: merged-results
          path: merged-results/
          retention-days: 30
      
      - name: Show summary
        run: |
          echo "## ğŸ“Š æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
          if [ -f "merged-results/summary.json" ]; then
            cat merged-results/summary.json >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… å¯ç”¨ç”¨æˆ·å" >> $GITHUB_STEP_SUMMARY
          if [ -f "merged-results/available.txt" ]; then
            head -20 merged-results/available.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "æ— " >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Commit results to repo
        run: |
          mkdir -p results
          cp merged-results/available.txt results/available.txt 2>/dev/null || true
          cp merged-results/failed.txt results/failed.txt 2>/dev/null || true
          cp merged-results/summary.json results/summary.json 2>/dev/null || true
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add results/
          git diff --cached --quiet || git commit -m "ğŸ“Š Results: $(date -u '+%Y-%m-%d %H:%M') UTC"
          git push
