# Gmail ç”¨æˆ·åæ£€æŸ¥å™¨ - åˆ†å¸ƒå¼ GitHub Actions Workflow
# 40 batch åˆ†ä¸¤è½®è·‘ï¼Œæ¯è½® 20 å¹¶å‘ï¼Œä¸€æ¬¡è§¦å‘è‡ªåŠ¨å®Œæˆå…¨éƒ¨
# ç»“æžœè‡ªåŠ¨æäº¤å›žä»“åº“

name: Gmail Username Checker

on:
  workflow_dispatch:
    inputs:
      request_delay:
        description: 'è¯·æ±‚é—´éš” (ms) - è¶Šå¤§è¶Šç¨³å®š'
        required: true
        default: '500'
        type: choice
        options:
          - '400'
          - '500'
          - '600'

jobs:
  # ========== ç¬¬ä¸€è½®ï¼šbatch 0-19 ==========
  check-round1:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    strategy:
      matrix:
        batch: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
      fail-fast: false
      max-parallel: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: gmail-checker-playwright/package-lock.json
      - name: Install deps
        working-directory: gmail-checker-playwright
        run: npm ci
      - name: Install Playwright
        working-directory: gmail-checker-playwright
        run: npx playwright install chromium --with-deps
      - name: Install xvfb
        run: sudo apt-get install -y xvfb
      - name: Check batch exists
        id: check
        run: |
          if [ -f "gmail-checker-playwright/batches/batch-${{ matrix.batch }}.txt" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - name: Run checker
        if: steps.check.outputs.exists == 'true'
        working-directory: gmail-checker-playwright
        run: |
          mkdir -p results-${{ matrix.batch }}
          xvfb-run --auto-servernum node checker-distributed.js batches/batch-${{ matrix.batch }}.txt results-${{ matrix.batch }}
        timeout-minutes: 210
        continue-on-error: true
      - name: Upload results
        if: always() && steps.check.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: results-batch-${{ matrix.batch }}
          path: gmail-checker-playwright/results-${{ matrix.batch }}/
          retention-days: 7
          if-no-files-found: warn

  # ========== ç¬¬äºŒè½®ï¼šbatch 20-39 ==========
  check-round2:
    needs: check-round1
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 240
    strategy:
      matrix:
        batch: [20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39]
      fail-fast: false
      max-parallel: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: gmail-checker-playwright/package-lock.json
      - name: Install deps
        working-directory: gmail-checker-playwright
        run: npm ci
      - name: Install Playwright
        working-directory: gmail-checker-playwright
        run: npx playwright install chromium --with-deps
      - name: Install xvfb
        run: sudo apt-get install -y xvfb
      - name: Check batch exists
        id: check
        run: |
          if [ -f "gmail-checker-playwright/batches/batch-${{ matrix.batch }}.txt" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - name: Run checker
        if: steps.check.outputs.exists == 'true'
        working-directory: gmail-checker-playwright
        run: |
          mkdir -p results-${{ matrix.batch }}
          xvfb-run --auto-servernum node checker-distributed.js batches/batch-${{ matrix.batch }}.txt results-${{ matrix.batch }}
        timeout-minutes: 210
        continue-on-error: true
      - name: Upload results
        if: always() && steps.check.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: results-batch-${{ matrix.batch }}
          path: gmail-checker-playwright/results-${{ matrix.batch }}/
          retention-days: 7
          if-no-files-found: warn

  # ========== åˆå¹¶ç»“æžœ ==========
  merge:
    needs: [check-round1, check-round2]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: results-batch-*
      - name: Merge results
        working-directory: gmail-checker-playwright
        run: |
          mkdir -p ../merged-results
          node merge-results.js ../all-results ../merged-results
      - name: Upload merged results
        uses: actions/upload-artifact@v4
        with:
          name: merged-results
          path: merged-results/
          retention-days: 30
      - name: Show summary
        run: |
          echo "## ðŸ“Š æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          if [ -f "merged-results/summary.json" ]; then
            cat merged-results/summary.json >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… å¯ç”¨ç”¨æˆ·å" >> $GITHUB_STEP_SUMMARY
          if [ -f "merged-results/available.txt" ]; then
            head -50 merged-results/available.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "æ— " >> $GITHUB_STEP_SUMMARY
          fi
      - name: Commit results to repo
        run: |
          mkdir -p results
          cp merged-results/available.txt results/available.txt 2>/dev/null || true
          cp merged-results/failed.txt results/failed.txt 2>/dev/null || true
          cp merged-results/summary.json results/summary.json 2>/dev/null || true
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add results/
          git diff --cached --quiet || git commit -m "ðŸ“Š Results: $(date -u '+%Y-%m-%d %H:%M') UTC"
          git push
