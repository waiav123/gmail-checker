# Gmail ç”¨æˆ·åæ£€æŸ¥å™¨ - ä»“åº“1ï¼šbatch 0-13
# å¤šä»“åº“ç­–ç•¥ï¼š3ä¸ªä»“åº“åŒæ—¶è·‘ï¼Œæ€»å…±40 jobå¹¶è¡Œ

name: Gmail Username Checker

on:
  workflow_dispatch:
    inputs:
      request_delay:
        description: 'è¯·æ±‚é—´éš” (ms)'
        required: true
        default: '500'
        type: choice
        options:
          - '400'
          - '500'
          - '600'

permissions:
  contents: write

env:
  REQUEST_DELAY: ${{ github.event.inputs.request_delay || '500' }}

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    strategy:
      matrix:
        batch: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]
      fail-fast: false
      max-parallel: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: gmail-checker-playwright/package-lock.json
      - name: Install deps
        working-directory: gmail-checker-playwright
        run: npm ci
      - name: Install Playwright
        working-directory: gmail-checker-playwright
        run: npx playwright install chromium --with-deps
      - name: Install xvfb
        run: sudo apt-get install -y xvfb
      - name: Run checker
        working-directory: gmail-checker-playwright
        run: |
          mkdir -p results-${{ matrix.batch }}
          xvfb-run --auto-servernum node checker-distributed.js batches/batch-${{ matrix.batch }}.txt results-${{ matrix.batch }}
        env:
          REQUEST_DELAY: ${{ env.REQUEST_DELAY }}
        timeout-minutes: 210
        continue-on-error: true
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-batch-${{ matrix.batch }}
          path: gmail-checker-playwright/results-${{ matrix.batch }}/
          retention-days: 7
          if-no-files-found: warn

  merge:
    needs: check
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: results-batch-*
      - name: Merge results
        working-directory: gmail-checker-playwright
        run: |
          mkdir -p ../merged-results
          node merge-results.js ../all-results ../merged-results
      - name: Upload merged results
        uses: actions/upload-artifact@v4
        with:
          name: merged-results
          path: merged-results/
          retention-days: 30
      - name: Show summary
        run: |
          echo "## ðŸ“Š ä»“åº“1 æ£€æŸ¥ç»“æžœ (batch 0-13)" >> $GITHUB_STEP_SUMMARY
          if [ -f "merged-results/summary.json" ]; then
            cat merged-results/summary.json >> $GITHUB_STEP_SUMMARY
          fi
      - name: Commit results to repo
        run: |
          mkdir -p results
          cp merged-results/available.txt results/available.txt 2>/dev/null || true
          cp merged-results/failed.txt results/failed.txt 2>/dev/null || true
          cp merged-results/degraded.txt results/degraded.txt 2>/dev/null || true
          cp merged-results/summary.json results/summary.json 2>/dev/null || true
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add results/
          git diff --cached --quiet || git commit -m "ðŸ“Š Repo1 Results: $(date -u '+%Y-%m-%d %H:%M') UTC"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
